# Job for building
jobs:
  include:
    - if: tag IS present
      os: linux
      language: python
      python: "3.6"
      dist: trusty
    - if: tag IS present
      os: osx
      language: generic
      env: PYTHON=3.6.5

before_install: |
  if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    brew update
    brew install openssl readline
    brew outdated pyenv || brew upgrade pyenv
    brew install pyenv-virtualenv
    pyenv install $PYTHON
    export PYENV_VERSION=$PYTHON
    export PATH="/Users/travis/.pyenv/shims:${PATH}"
    pyenv-virtualenv venv
    source venv/bin/activate
    python --version
  fi

# Install dependencies
install:
  - pip install -U -r requirements.txt

# Perform build
script:
  - python setup.py build


# Zip files before deploy
before_deploy:
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      zip -r dist/darwin.zip build/ -x "*.DS_Store";
    fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      zip -r dist/linux.zip build/;
    fi

# S3 Deploy
deploy:
  provider: s3
  access_key_id: "AKIAJQVWOER2UGVDXHBQ"
  secret_access_key: "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"
  bucket: "mihirpathak"
  skip_cleanup: true
  acl: public_read
  region: ap-south-1
  local_dir: dist
  upload-dir: audius/binaries/rainbow
  on:
    all_branches: true

after_deploy:
  - echo "Finished uploading artifacts"
